<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>POPMAP Login</title>
<style>
body {
    font-family: "Segoe UI", sans-serif;
    background: #f4f4f4;
    display:flex;
    justify-content:center;
    align-items:center;
    height:100vh;
    margin:0;
}

/* In-page alert */
#site-alert {
    position: fixed;
    top: 10px;
    left: 50%;
    transform: translateX(-50%);
    background: #f44336;
    color: white;
    padding: 10px 20px;
    border-radius: 4px;
    display: none;
    z-index: 9999;
    box-shadow: 0 2px 8px rgba(0,0,0,0.2);
}

#login-container {
    background:white;
    padding:30px;
    border-radius:8px;
    box-shadow:0 4px 12px rgba(0,0,0,0.15);
    width:360px;
    text-align:center;
}

#login-container input {
    width:100%;
    padding:10px;
    margin:8px 0;
    border-radius:4px;
    border:1px solid #ccc;
    box-sizing:border-box;
    background:#f4f4f4;
    font-size:14px;
}

.input-with-button {
    position:relative;
    width:100%;
    margin:10px 0;
}

.input-with-button button {
    position:absolute;
    right:6px;
    top:50%;
    transform:translateY(-50%);
    height:32px;
    min-width:60px;
    border:none;
    border-radius:4px;
    background:#2980b9;
    color:white;
    font-weight:bold;
    cursor:pointer;
}

.input-with-button button:hover { background:#3498db; }

#login-container button.login-btn {
    width:100%;
    margin-top:10px;
    padding:10px;
    border-radius:4px;
    border:none;
    background:#2980b9;
    color:white;
    cursor:pointer;
}

#login-container button.login-btn:hover { background:#3498db; }
</style>
</head>
<body>


<div id="site-alert"></div>

<div id="login-container">
    <h2>POPMAP Login</h2>
    <input type="text" id="callsign" placeholder="Callsign">
    <div class="input-with-button">
        <input type="text" id="contact" placeholder="Email">
        <button type="button" onclick="requestOTP()">Send</button>
    </div>
    <input type="text" id="otp" placeholder="Enter OTP">
    <button class="login-btn" type="button" onclick="verifyOTP()">Login</button>
</div>

<script>
// ================= In-page alert helper =================
function showAlert(msg, type='error', duration=3000){
    const alertDiv = document.getElementById('site-alert');
    alertDiv.textContent = msg;
    if(type === 'success') alertDiv.style.background = '#4CAF50';
    else if(type === 'warning') alertDiv.style.background = '#FF9800';
    else alertDiv.style.background = '#f44336';
    alertDiv.style.display='block';
    setTimeout(()=>{ alertDiv.style.display='none'; }, duration);
}

// ================= OTP functions =================
async function requestOTP() {
    const callsign = document.getElementById('callsign').value.trim();
    const contact = document.getElementById('contact').value.trim();
    if (!callsign || !contact) { showAlert("Enter callsign and email"); return; }

    try {
        const res = await fetch('/request_otp', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({user: contact})
        });
        const data = await res.json();
        if(data.success){ showAlert("OTP sent! Check your email.", 'success'); document.getElementById('otp').focus(); }
        else { showAlert("Error sending OTP: " + data.error); }
    } catch(err){ showAlert("Network error: " + err); }
}

async function verifyOTP() {
    const contact = document.getElementById('contact').value.trim();
    const otp = document.getElementById('otp').value.trim();
    if (!contact || !otp) { showAlert("Fill all fields"); return; }

    try {
        const res = await fetch('/login_verify', {
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body: JSON.stringify({user: contact, otp: otp})
        });
        const data = await res.json();
        if(data.success){ showAlert("Login successful!", 'success'); window.location.href = '/map'; }
        else { showAlert(data.error); }
    } catch(err){ showAlert("Network error: " + err); }
}

// ================= Enter key triggers =================
document.getElementById('contact').addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); document.querySelector('.input-with-button button').click(); }
});
document.getElementById('otp').addEventListener('keydown', e=>{
    if(e.key==='Enter'){ e.preventDefault(); document.querySelector('.login-btn').click(); }
});
</script>
</body>
</html>
